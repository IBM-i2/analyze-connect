<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html>
  
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Authentication </title>
    <meta name="viewport" content="width=device-width">
    <meta name="title" content="Authentication ">
    <meta name="generator" content="docfx 2.56.2.0">
    
    <link rel="shortcut icon" href="../../images/favicon.png">
    <link rel="stylesheet" href="../../styles/docfx.vendor.css">
    <link rel="stylesheet" href="../../styles/docfx.css">
    <link rel="stylesheet" href="../../styles/main.css">
    <meta property="docfx:navrel" content="../../toc.html">
    <meta property="docfx:tocrel" content="../../guidetoc/toc.html">
    
    <meta property="docfx:rel" content="../../">
    
  </head>
  <body data-spy="scroll" data-target="#affix" data-offset="120">
    <div id="wrapper">
      <header>
        
        <nav id="autocollapse" class="navbar navbar-inverse ng-scope" role="navigation">
          <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              
              <a class="navbar-brand" href="../../index.html">
                <strong>i2 Connect gateway</strong>
              </a>
            </div>
            <div class="collapse navbar-collapse" id="navbar">
              <form class="navbar-form navbar-right" role="search" id="search">
                <div class="form-group">
                  <input type="text" class="form-control" id="search-query" placeholder="Search" autocomplete="off">
                </div>
              </form>
            </div>
          </div>
        </nav>
      </header>
      <div class="container body-content">
        
        <div id="search-results">
          <div class="search-list"></div>
          <div class="sr-items">
            <p><i class="glyphicon glyphicon-refresh index-loading"></i></p>
          </div>
          <ul id="pagination"></ul>
        </div>
      </div>
      <div role="main" class="container body-content hide-when-search">
        
        <div class="sidenav hide-when-search">
          <a class="btn toc-toggle collapse" data-toggle="collapse" href="#sidetoggle" aria-expanded="false" aria-controls="sidetoggle">Show / Hide Table of Contents</a>
          <div class="sidetoggle collapse" id="sidetoggle">
            <div id="sidetoc"></div>
          </div>
        </div>
        <div class="article row grid-right">
          <div class="col-md-10">
          
          <div class="subnav navbar navbar-default">
            <div class="container hide-when-search" id="breadcrumb">
              <ul class="breadcrumb">
                <li></li>
              </ul>
            </div>
          </div>
            <article class="content wrap" id="_content" data-uid="">
<h1 id="authentication">Authentication</h1>

<p>The Auth connector demonstrates the ability to configure authentication for individual services on a connector. Since i2 Analyze version 4.3.4, you can configure a connector service to require a user&#39;s credentials before initiating a query, be it synchronous or asynchronous. This mechanism enables connectors to authenticate users with third-party services.</p>
<p>Similar to client configurations, you can define reusable authentication configurations that can be shared across services in the connector configuration. These are groups of form fields that the user fills in with their credentials in order to authenticate.</p>
<p>After a user authenticates with a service using a specific authentication configuration, the user is able to query all services that use the same authentication configuration.</p>
<blockquote><p><strong>Note</strong>: Connector service authentication is completely separate from Liberty&#39;s user authentication. Connector service authentication is managed on the connector domain and controls access to connector services. Liberty&#39;s user authentication is managed by the i2 Analyze server, controlling access to the i2 Connect gateway.</p>
</blockquote>
<h2 id="configuring-authentication-for-a-synchronous-service">Configuring authentication for a synchronous service</h2>
<p>The following are the steps required to successfully set up authentication for a synchronous service.</p>
<h3 id="1-defining-an-authentication-configuration">1. Defining an authentication configuration</h3>
<p>Authentication configurations are defined in the <code>authConfigs</code> array of a connector&#39;s configuration. For example, the Auth connector defines two authentication configurations in its <code>config.json</code> file:</p>
<pre><code class="lang-json">{
  &quot;defaultValues&quot;: { ... },
  &quot;services&quot;: [ ... ],
  &quot;authConfigs&quot;: [
    {
      &quot;id&quot;: &quot;authConfig1&quot;,
      &quot;loginUrl&quot;: &quot;/login/userpass&quot;,
      &quot;form&quot;: {
        &quot;description&quot;: &quot;This service requires a username and password.&quot;,
        &quot;fields&quot;: [
          {
            &quot;id&quot;: &quot;username&quot;,
            &quot;label&quot;: &quot;Username&quot;,
            &quot;type&quot;: &quot;text&quot;
          },
          {
            &quot;id&quot;: &quot;password&quot;,
            &quot;label&quot;: &quot;Password&quot;,
            &quot;type&quot;: &quot;password&quot;
          }
        ]
      }
    },
    {
      &quot;id&quot;: &quot;authConfig2&quot;,
      &quot;loginUrl&quot;: &quot;/login/apikey&quot;,
      &quot;form&quot;: {
        &quot;description&quot;: &quot;This service requires an API key.&quot;,
        &quot;fields&quot;: [
          {
            &quot;id&quot;: &quot;apikey&quot;,
            &quot;label&quot;: &quot;API Key&quot;,
            &quot;type&quot;: &quot;password&quot;
          }
        ]
      }
    }
  ]
}
</code></pre><p>In the above, two <code>authConfigs</code> are defined. Each configuration has:</p>
<ul>
<li>An <code>id</code> which needs to be unique among the <code>authConfigs</code>.</li>
<li>A <code>loginUrl</code> which is relative to the connector&#39;s base URL. This is used to determine where authentication requests should be made.</li>
<li>A <code>form</code> object which includes the following:<ul>
<li>A <code>description</code> briefly describing the form.</li>
<li>A <code>fields</code> property which is an array of form fields. Each form field is an object containing:<ul>
<li>An <code>id</code> unique among the form fields.</li>
<li>A <code>label</code> shown on the user interface alongside the form field.</li>
<li>A <code>type</code> indicating the type of user input. Accepted values are <code>text</code> and <code>password</code>.</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="2-assigning-an-authentication-configuration-to-a-service">2. Assigning an authentication configuration to a service</h3>
<p>For a general understanding about how to add a service, see <a href="../walkthrough/4-add-service.html">Adding a service</a>.</p>
<p>To configure a service to use an authentication configuration, add an <code>authConfigId</code> field in the connector service definition and assign it the ID of the authentication configuration. For example:</p>
<pre><code class="lang-json">{
  &quot;defaultValues&quot;: { ... },
  &quot;services&quot;: [
    {
      &quot;id&quot;: &quot;acquire-service&quot;,
      &quot;name&quot;: &quot;Acquire Service&quot;,
      &quot;description&quot;: &quot;Acquires all data. Requires authentication.&quot;,
      &quot;clientConfigType&quot;: &quot;NONE&quot;,
      &quot;authConfigId&quot;: &quot;authConfig1&quot;
    }
  ],
  &quot;authConfigs&quot;: [ ... ]
}
</code></pre><p>You cannot assign multiple authentication configurations to a single service. But you can assign the same authentication configuration to multiple services.</p>
<h3 id="3-implementing-the-login-endpoint">3. Implementing the login endpoint</h3>
<p>The login endpoint is called when the user submits their credentials for a service using an authentication configuration.</p>
<p>Here, the submitted credentials should be checked to ensure they are valid. If they are, the login endpoint should generate an authorization token string and include that in the response body like so:</p>
<pre><code class="lang-json">{
  token: &quot;authorization-token-string&quot;
}
</code></pre><p>The Auth connector example generates signed JSON Web Tokens (JWTs) which the endpoint responds with as an example. You are free to use your own token generation and verification mechanisms.</p>
<p>This generated token is cached by the gateway and used in subsequent connector requests to services using the same authentication configuration.</p>
<p>If the credentials are invalid, the endpoint should respond with a <code>401</code> status code alongside an <a href="https://tools.ietf.org/html/rfc7807">RFC7807</a> (<code>ProblemDetails</code>) response body. This <code>ProblemDetails</code> object contains the following fields:</p>
<ul>
<li>The <code>title</code>; a brief summary of the problem.</li>
<li>The <code>detail</code>; An explanation specific to the occurrence of the problem.</li>
<li>The <code>type</code>; a URI reference that identifies the problem type. To indicate the problem is caused by a connector authentication error, this value must be set to:
<code>urn:uuid:264caa46-75cb-4ac5-891a-11adeb48b6fb</code></li>
<li>The <code>status</code>; the HTTP response code (usually a <code>401</code>).</li>
<li>The <code>instance</code>; an optional URI reference which identifies the specific occurrence of the problem, relative to the connector&#39;s base URL. Absolute URLs are also accepted.</li>
</ul>
<h3 id="4-implementing-authentication-verification-on-endpoints">4. Implementing authentication verification on endpoints</h3>
<p>The gateway uses <a href="https://swagger.io/docs/specification/authentication/bearer-authentication/">bearer authentication</a> to authorize requests made to protected resources. In this authentication scheme, security tokens are sent in the <code>Authorization</code> header of the request, looking like the following:</p>
<pre><code class="lang-http">Authorization: Bearer &lt;token&gt;
</code></pre><p>To implement verification of authentication for the service, the token submitted in the <code>Authorization</code> header of the request needs to be validated.</p>
<p>If you are not outsourcing the verification of authentication tokens to a third-party service, your connector implementation will need to ensure the following:</p>
<ul>
<li>The <code>Authorization</code> header exists on the request</li>
<li>It starts with the <code>Bearer</code> prefix</li>
<li>The <code>&lt;token&gt;</code> exists and is valid (i.e. is the same as the one generated in the login request).</li>
</ul>
<p>If the token is valid, the acquire endpoint should respond with entities and links as usual. If the above validation fails, the acquire endpoint should respond with a <code>401</code> and a <code>ProblemDetails</code> body.</p>
<p>Additionally, if the connector service has a validate endpoint, the same restriction logic needs to be applied for it.</p>
<h2 id="configuring-authentication-for-an-asynchronous-service">Configuring authentication for an asynchronous service</h2>
<p>If you are not familiar with setting up and using asynchronous services on a connector, refer to the <a href="connector-async.html">Async connector</a>.</p>
<p>Similarly to <a href="#configuring-authentication-for-a-synchronous-service">configuring authentication for a synchronous service</a>, an authentication configuration needs be defined and assigned to the asynchronous service you want to configure authentication for in the connector configuration.</p>
<p>To ensure requests to an asynchronous service are made by an authenticated user, all the query endpoints must validate the contents of the <code>Authorization</code> header, similarly to how an acquire endpoint is configured for authentication. This includes the:</p>
<ul>
<li><a href="connector-async.html#2-implementing-the-acquire-endpoint">Async acquire</a> endpoint</li>
<li><a href="connector-async.html#3-implementing-the-status-endpoint">Status</a> endpoint</li>
<li><a href="connector-async.html#4-implementing-a-results-endpoint">Results</a> endpoint</li>
</ul>
<p>This is because, even after launching the asynchronous query, it is possible for the token to expire or otherwise become invalidated while the query is running. In which case, the connector should respond with a <code>401</code> and <code>ProblemDetails</code> body to the gateway to indicate that the user needs to reauthenticate before the query can continue. In such events, the client would request for the user to re-input credentials before the running query resumes or a completed query displays results.</p>
<p>The Delete endpoint can also validate the authentication token provided although this is not strictly necessary.</p>
<h2 id="setup">Setup</h2>
<p>These instructions are for setting up and running the Auth connector.</p>
<p>If you are not familiar with <a href="../walkthrough/2-deploy-i2-analyze.html">deploying i2 Analyze with the i2 Connect gateway</a> or <a href="../miscellaneous/deploy-i2-analyze-is-daod.html">deploying i2 Analyze with the Information Store and the i2 Connect gateway</a> and have not previously done so, you must do so now.</p>
<h3 id="1-add-connector-to-topology">1. Add connector to topology</h3>
<p>In your <code>topology.xml</code> file in <code>toolkit\configuration\environment</code>, add a new <code>&lt;connector-id&gt;</code> element for the Auth connector:</p>
<pre><code class="lang-xml">&lt;wars&gt;
  &lt;war ... name=&quot;opal-services-daod&quot; ... &gt;
    ...
    &lt;connector-ids&gt;
      &lt;connector-id value=&quot;auth-connector&quot;/&gt;
    &lt;/connector-ids&gt;
    ...
  &lt;/war&gt;
&lt;/wars&gt;
</code></pre><p>Additionally, add a new <code>&lt;connector&gt;</code> element to the topology:</p>
<pre><code class="lang-xml">&lt;ns1:topology ...&gt;
  ...
  &lt;connectors&gt;
    &lt;connector base-url=&quot;http://localhost:9086&quot; name=&quot;Auth Connector&quot; id=&quot;auth-connector&quot;/&gt;
  &lt;/connectors&gt;
&lt;/ns1:topology&gt;
</code></pre><p>Ensure that you are using the same port as specified in <code>application.properties</code> (<code>9086</code> by default) and that the value of the <code>id</code> attribute is the same as the <code>value</code> attribute of its corresponding <code>&lt;connector-id&gt;</code>.</p>
<h3 id="2-configure-the-schema">2. Configure the schema</h3>
<p>Choose whether you want to configure the Auth schema as a connector schema or a gateway schema.</p>
<h4 id="connector-schema">Connector schema</h4>
<p>By default, your connector has the Auth schema configured as a connector schema. <code>schemaUrl</code>, <code>chartingSchemesUrl</code>, and <code>schemaShortName</code> are defined in the Auth connector&#39;s <code>config.json</code> file, in <code>auth\auth-connector\src\main\resources</code>.</p>
<p>Additionally, ensure the following is true:</p>
<ul>
<li>The connector&#39;s <code>config.json</code> <strong>does not</strong> contain a <code>gatewaySchema</code> property.</li>
<li>The Auth <code>&lt;connector&gt;</code> element in your i2 Analyze topology <strong>does not</strong> contain a <code>gateway-schema</code> attribute.</li>
</ul>
<p>For more information, see <a href="../schemas/connector-schema.html">configuring a connector schema</a>.</p>
<h4 id="gateway-schema">Gateway schema</h4>
<p>If you want to set up the Auth schema as a gateway schema, follow the guidelines for <a href="../schemas/gateway-schema.html">configuring a gateway schema</a> using the Auth schema and charting scheme in the <code>schema</code> directory of this repository.</p>
<p>Additionally, ensure the following is true:</p>
<ul>
<li>The connector&#39;s <code>config.json</code> in <code>auth\auth-connector\src\main\resources</code> <strong>does not</strong> contain the <code>schemaUrl</code>, <code>chartingSchemesUrl</code> and <code>schemaShortName</code> properties. These properties exist on the configuration by default. If they are present, remove them.</li>
<li>The Auth <code>&lt;connector&gt;</code> element in your i2 Analyze topology <strong>does not</strong> contain a <code>schema-short-name</code> attribute.</li>
</ul>
<h3 id="3-run-the-auth-connector">3. Run the Auth connector</h3>
<p>To run the connector, navigate to <code>connector\auth\auth-connector</code> in your terminal and run the application using the following command:</p>
<pre><code class="lang-shell">mvnw spring-boot:run
</code></pre><h3 id="4-deploy-and-start-i2-analyze">4. Deploy and start i2 Analyze</h3>
<p>Deploy and start the Liberty server.</p>
<pre><code class="lang-shell">setup -t deployLiberty
setup -t startLiberty
</code></pre></article>
          </div>
          
          <div class="hidden-sm col-md-2" role="complementary">
            <div class="sideaffix">
              <nav class="bs-docs-sidebar hidden-print hidden-xs hidden-sm affix" id="affix">
              <!-- <p><a class="back-to-top" href="#top">Back to top</a><p> -->
              </nav>
            </div>
          </div>
        </div>
      </div>
      
      <footer>
        <div class="grad-bottom"></div>
        <div class="footer">
          <div class="container">
            <span class="pull-right">
              <a href="#top">Back to top</a>
            </span>
            &copy; N. Harris Computer Corporation (2022).
            
          </div>
        </div>
      </footer>
    </div>
    
    <script type="text/javascript" src="../../styles/docfx.vendor.js"></script>
    <script type="text/javascript" src="../../styles/docfx.js"></script>
    <script type="text/javascript" src="../../styles/main.js"></script>
  </body>
</html>
